<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Off-chain operations - Walrus</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Walrus</a></li><li class="chapter-item expanded affix "><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">About Walrus</li><li class="chapter-item expanded "><a href="../overview/objectives_use_cases.html"><strong aria-hidden="true">1.</strong> Objectives and use-cases</a></li><li class="chapter-item expanded "><a href="../overview/overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../overview/architecture.html"><strong aria-hidden="true">2.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../overview/encoding.html"><strong aria-hidden="true">2.2.</strong> Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../overview/operations.html"><strong aria-hidden="true">3.</strong> Operations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../overview/operations-sui.html"><strong aria-hidden="true">3.1.</strong> Sui operations</a></li><li class="chapter-item expanded "><a href="../overview/operations-off-chain.html" class="active"><strong aria-hidden="true">3.2.</strong> Off-chain operations</a></li></ol></li><li class="chapter-item expanded "><a href="../overview/properties.html"><strong aria-hidden="true">4.</strong> Properties</a></li><li class="chapter-item expanded "><a href="../overview/future.html"><strong aria-hidden="true">5.</strong> Future discussion</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../dev-guide/dev-guide.html"><strong aria-hidden="true">6.</strong> Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../dev-guide/components.html"><strong aria-hidden="true">6.1.</strong> Components</a></li><li class="chapter-item expanded "><a href="../dev-guide/dev-operations.html"><strong aria-hidden="true">6.2.</strong> Operations</a></li><li class="chapter-item expanded "><a href="../dev-guide/sui-struct.html"><strong aria-hidden="true">6.3.</strong> Sui structures</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/setup.html"><strong aria-hidden="true">7.</strong> Setup</a></li><li class="chapter-item expanded "><a href="../usage/interacting.html"><strong aria-hidden="true">8.</strong> Interacting with Walrus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/client-cli.html"><strong aria-hidden="true">8.1.</strong> Using the client CLI</a></li><li class="chapter-item expanded "><a href="../usage/json-api.html"><strong aria-hidden="true">8.2.</strong> Using the client JSON API</a></li><li class="chapter-item expanded "><a href="../usage/web-api.html"><strong aria-hidden="true">8.3.</strong> Using the client HTTP API</a></li></ol></li><li class="chapter-item expanded "><a href="../usage/examples.html"><strong aria-hidden="true">9.</strong> Examples</a></li><li class="chapter-item expanded affix "><li class="part-title">Walrus sites</li><li class="chapter-item expanded "><a href="../walrus-sites/intro.html"><strong aria-hidden="true">10.</strong> Introduction to Walrus Sites</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial.html"><strong aria-hidden="true">11.</strong> Your first Walrus Site</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-install.html"><strong aria-hidden="true">11.1.</strong> Installing the site builder</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-publish.html"><strong aria-hidden="true">11.2.</strong> Publishing a Walrus Site</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-suins.html"><strong aria-hidden="true">11.3.</strong> Bonus: Set a SuiNS name</a></li><li class="chapter-item expanded "><a href="../walrus-sites/tutorial-config.html"><strong aria-hidden="true">11.4.</strong> Advanced configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../walrus-sites/overview.html"><strong aria-hidden="true">12.</strong> Technical overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../walrus-sites/site-builder.html"><strong aria-hidden="true">12.1.</strong> The site builder</a></li><li class="chapter-item expanded "><a href="../walrus-sites/portal.html"><strong aria-hidden="true">12.2.</strong> The Walrus Sites Portal</a></li><li class="chapter-item expanded "><a href="../walrus-sites/restrictions.html"><strong aria-hidden="true">12.3.</strong> Known restrictions</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../glossary.html">Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walrus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="off-chain-operations"><a class="header" href="#off-chain-operations">Off-chain operations</a></h1>
<p>Walrus operations happen off Sui, but may interact with the Sui flows defining the resource life
cycle.</p>
<h2 id="write-paths"><a class="header" href="#write-paths">Write paths</a></h2>
<p><img src="../assets/WriteFlow.png" alt="Write paths of Walrus" /></p>
<p>Systems overview of writes, illustrated above:</p>
<ul>
<li>A user acquires a storage resource of appropriate size and duration on-chain, either by directly
buying it on the Walrus system object, or a secondary market. A user can split, merge, and
transfer owned storage resources.</li>
<li>When a user wants to write a blob, it first erasure codes it using encode, and computes the
blob ID. Then they can perform the following steps themselves, or use a publisher to perform steps
on their behalf.</li>
<li>The user goes on chain (Sui) and updates a storage resource to register the blob ID with the
desired size and lifetime. This emits an event, received by storage nodes. Once the
user receives they then continue the upload.</li>
<li>The user sends each of the blob slivers and metadata to the storage nodes that currently
manages the corresponding shards.</li>
<li>A storage node managing a shard receives a sliver and checks it against the blob ID.
It also checks that there is a blob resource with the blob ID that is authorized to store
a blob. If correct, then the storage node signs a statement that it holds the sliver for blob ID
(and metadata) and returns it to the user.</li>
<li>The user puts together the signatures returned from storage nodes into an availability certificate
and sends it on chain. When the certificate is verified on-chain an availability event for the
blob ID is emitted, and all other storage nodes seek to download any missing shards for the blob
ID. This event emitted by Sui is the <a href="./properties.html">Point of Availability (PoA)</a> for the blob
ID.</li>
<li>After the PoA, and without user involvement, storage nodes sync and recover any missing slivers.</li>
</ul>
<p>The user waits for 2/3 of shard signatures to return in order to create the certificate of
availability. The rate of the code is below 1/3 allowing for reconstruction even if only 1/3 of
shards return the sliver for a read. Since at most 1/3 of the storage nodes can fail, this ensures
reconstruction if a reader requests slivers from all storage nodes. Note that the full process can
be mediated by a publisher, that receives a blob and drives the process to completion.</p>
<h2 id="refresh-availability"><a class="header" href="#refresh-availability">Refresh availability</a></h2>
<p>Since no content data is required to refresh the duration of storage, refresh is conducted fully on
chain within the protocol. To request an extension to the availability of a blob, a user
provides an appropriate storage resource. Upon success this emits an event that storage nodes
receive to extend the time for which each sliver is stored.</p>
<h2 id="inconsistent-resource-flow"><a class="header" href="#inconsistent-resource-flow">Inconsistent resource flow</a></h2>
<p>When a correct storage node tries to reconstruct a shard it may fail if the encoding of a blob ID
past <a href="./properties.html">PoA</a> was incorrect, but will instead extract an inconsistency proof for the
blob ID. It will then use the proof to create a inconsistency certificate and upload it on chain.
The flow is as follows:</p>
<ul>
<li>A storage node fails to reconstruct a shard, and instead holds an inconsistency proof.</li>
<li>The storage node sends the blob ID and inconsistency proof to all storage nodes of the Walrus
epoch. The storage node verify the proof and sign it.</li>
<li>The storage node aggregate the signatures into an inconsistency certificate and sends it to the
Walrus smart contract, that verifies it and emits a inconsistent resource event.</li>
<li>Upon receiving an inconsistent resource event, correct storage nodes delete sliver data for the
blob ID and record in the metadata to return None for the blob ID for the
<a href="./properties.html">availability period</a>. No storage attestation challenges are issued for this
blob ID.</li>
</ul>
<p>Note that a blob ID that is inconsistent will always resolve to None upon reading: this is because
the read process re-encodes the received blob to check that the blob ID is correctly derived from a
consistent encoding. This means that an inconsistency proof only reveals a true fact to storage
nodes (that do not otherwise ran decoding), and does not change the output of read in any case.</p>
<p>Note however that partial reads leveraging the systematic nature of the encoding may return partial
reads for inconsistently encoded files. Thus if consistency and availability of reads is important
dapps should do full reads rather than partial reads.</p>
<h2 id="read-paths"><a class="header" href="#read-paths">Read paths</a></h2>
<p>A user can read stored blobs either directly or through a cache. We discuss here the direct user
journey since this is also how the cached operates in case of a cache miss. We assume that most
reads will happen through caches, for blobs that are hot, and will not result in requests to
storage nodes.</p>
<ul>
<li>The reader gets the metadata for the blob ID from any storage node, and authenticates it using
the blob ID.</li>
<li>The reader then sends a request to the storage node for the shards corresponding to the blob ID,
and waits for f+1 to respond. Sufficient requests are sent in parallel to ensure low latency for
reads.</li>
<li>The reader authenticates the slivers returned with the blob ID, reconstructs the blob, and decides
whether the contents are a valid blob or inconsistent.</li>
<li>Optionally, for a cache, the result is cached and can be served without reconstruction until it is
evicted from the cache. Requests for the blob to the cache return the blob contents, or a proof
the blob is inconsistently encoded.</li>
</ul>
<h2 id="challenge-mechanism-for-storage-attestation"><a class="header" href="#challenge-mechanism-for-storage-attestation">Challenge mechanism for storage attestation</a></h2>
<p>During an epoch a correct storage node challenges all shards to provide blob slivers past PoA:</p>
<ul>
<li>The list of available blobs for the epoch is determined by the sequence of Sui events up
to the past epoch. Inconsistent blobs are not challenged, and a record proving this status
can be returned instead.</li>
<li>A challenge sequence is determined by providing a seed to the challenged shard. The sequence is
then computed based both on the seed AND the content of each challenged blob ID. This creates a
sequential read dependency.</li>
<li>The response to the challenge provides the sequence of shard contents for the blob IDs in a
timely manner.</li>
<li>The challenger node uses thresholds to determine whether the challenge was passed, and reports
the result on chain.</li>
<li>The challenge / response communication is authenticated.</li>
</ul>
<p>Challenges provide some reassurance that the storage node actually can recover shard data in a
probabilistic manner, avoiding storage nodes getting payment without any evidence they may retrieve
shard data. The sequential nature of the challenge and some reasonable timeout also ensure that
the process is timely.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../overview/operations-sui.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../overview/properties.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../overview/operations-sui.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../overview/properties.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
